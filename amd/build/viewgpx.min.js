define(["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","mod_treasurehunt/ol3-layerswitcher","core/str"],function(a,b,c,d,e,f,g){function h(b,c,d,f,g){function h(a){var b=[],c="";if(C.forEachFeatureAtPixel(a,function(a){b.push(a)}),b.length>0){var d,e,f=[];for(d=0,e=b.length;d<e;++d)f.push(b[d].get("desc"));c=f.join(", ")||"(unknown)",C.getTarget().style.cursor="pointer"}else C.getTarget().style.cursor="";return c}function i(b){var c=E.getElement(),d=b.coordinate;a(c).popover("destroy"),E.setPosition(d),a(c).popover({placement:"top",animation:!1,html:!0,content:h(C.getEventPixel(b.originalEvent))}),a(c).popover("show")}var j="EPSG:3857",o=null,p=!0;if("undefined"!=typeof g&&null!=g){if(null!=g.custombackgroundurl){var q=e.proj.transformExtent(g.bbox,"EPSG:4326",j);if(!g.geographic){var r=(q[2]-q[0],q[3]-q[1]),s=(q[2]+q[0])/2,t=(q[3]+q[1])/2,u=Math.round(r/g.imgheight),v=Math.round(g.imgwidth*u),w=Math.round(g.imgheight*u);q=[s-v/2,t-w/2,s+v/2,t+w/2]}o=new e.layer.Image({title:g.layername,type:g.layertype,source:new e.source.ImageStatic({url:g.custombackgroundurl,imageExtent:q}),opacity:1})}else if(null!=g.wmsurl){var x={source:new e.source.TileWMS({url:g.wmsurl,params:g.wmsparams}),type:g.layertype,title:g.layername};if(null!=g.bbox[0]&&null!=g.bbox[1]&&null!=g.bbox[2]&&null!=g.bbox[3]){var y=e.proj.transformExtent(g.bbox,"EPSG:4326",j);x.extent=y}o=new e.layer.Tile(x)}p=g.geographic}var z=new e.layer.Group({title:d.basemaps,layers:[new e.layer.Tile({title:d.aerialmap,type:"base",visible:!1,source:new e.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new e.layer.Tile({title:d.roadmap,type:"base",visible:!0,source:new e.source.OSM})]});null!==o&&(g.onlybase&&z.getLayers().clear(),z.getLayers().push(o));var A=new e.layer.Group({title:d.trackviewer,layers:[]}),B=(new e.layer.Heatmap({title:"Heatmap",source:new e.source.Vector({url:"gpx.php?id="+b+"&userid=24",format:new e.format.GPX}),blur:20,radius:10}),new e.control.LayerSwitcher),C=new e.Map({layers:[z,A],renderer:"canvas",target:document.getElementById("mapgpx"),view:new e.View({center:[0,0],zoom:2,minZoom:2}),controls:e.control.defaults().extend([B])});B.showPanel();var D=new e.interaction.Select({style:function(a){var b=D.getLayer(a),c=b.iconurl,d=l(a,c,!0);return d}});C.addInteraction(D),k(f,b,C,A,B);var E=new e.Overlay({element:document.getElementById("info")});C.addOverlay(E),C.on("pointermove",function(a){a.dragging}),C.on("click",function(a){i(a)});var F=null;a("#refreshtracks").change(function(){a(this).is(":checked")?(n=0,a("#timecircle").show(),F=setInterval(function(){a("#timecircle").text(m-n++%m)},1e3)):(a("#timecircle").hide(),clearInterval(F))})}function i(a,b){var c=null,d=a.getLayers();return d.forEach(function(a){a.get("title")==b&&(c=a)}),c||(c=new e.layer.Group({title:b,layers:[]}),a.addLayer(c)),c}function j(a,b,c){var d=700,e=a.getView();c?e.fit(c,{duration:d}):e.animate({zoom:19,center:b,duration:d})}function k(b,c,d,f,g){var h=null;b.forEach(function(b){var i=new e.source.Vector({url:"gpx.php?id="+c+"&userid="+b.id,format:new e.format.GPX}),k=b.pic.indexOf('<img src="')+10,o=b.pic.indexOf('"',k),p=b.pic.substring(k,o),q=new e.layer.Vector({source:i,title:b.pic+""+b.fullname,style:function(a){var b=l(a,p,!1);return b}});q.iconurl=p,setInterval(function(){a("#refreshtracks").is(":checked")&&(n=0,i.clear(),i.refresh())},1e3*m),q.on("change:visible",function(){if(this.getVisible()){var a=this.getSource().getExtent();j(d,null,a)}}),i.on("change",function(){if(!a("#refreshtracks").is(":checked")){var b=i.getExtent();null===h?h=b:(h[0]=Math.min(h[0],b[0]),h[1]=Math.min(h[1],b[1]),h[2]=Math.max(h[2],b[2]),h[3]=Math.max(h[3],b[3])),j(d,null,h)}},this),f.getLayers().push(q),g&&g.renderPanel()})}function l(a,b,c){var d=[new e.style.Style({stroke:new e.style.Stroke({color:"rgba(255,255,255,0.8)",width:6+2*c}),zIndex:1+4*c}),new e.style.Style({stroke:new e.style.Stroke({color:"#ff0000",width:1+c,lineDash:[10,8]}),fill:new e.style.Fill({color:"rgba(255,0,0,0.5)"}),zIndex:2+4*c}),new e.style.Style({image:new e.style.Circle({radius:3+2*c,stroke:new e.style.Stroke({color:"white",width:1+c}),fill:new e.style.Fill({color:"red"})}),geometry:function(a){var b=a.getGeometry().getCoordinates()[0];return new e.geom.MultiPoint(b)},zIndex:3+4*c})],f=a.getGeometry(),g=f.getLastCoordinate();return d.push(new e.style.Style({geometry:new e.geom.Point(g),image:new e.style.Icon({src:b,anchor:[.75,.5],rotateWithView:!1}),zIndex:4+4*c})),d}var m=30,n=0,o={addgpxlayer:function(a,b,c,d,e,f){var g=i(a,f);return k([e],b,a,g,null),g},creategpxviewer:function(a,b,c,d,e){var f=["aerialmap","roadmap","basemaps","searchlocation","trackviewer"],i=f.map(function(a){return{key:a,component:"treasurehunt"}});m=e,g.get_strings(i).done(function(e){for(var g=[],i=0;i<f.length;i++)g[f[i]]=e[i];if("undefined"!=typeof d&&null!==d&&null!==d.custombackgroundurl){var j=new Image;j.addEventListener("load",function(){d.imgwidth=this.naturalWidth,d.imgheight=this.naturalHeight,h(a,b,g,c,d)}),j.src=d.custombackgroundurl}else h(a,b,g,c,d)})}};return o});