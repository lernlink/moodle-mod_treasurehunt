define(["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/geocoder","mod_treasurehunt/ol3-layerswitcher","core/str"],function(a,b,c,d,e,f,g,h,i){function j(b,c,h,i,j,k){function l(b,c,d,e,f,g){var h,i=a(b).get([d]),j=a(i).attr("roadid");h=Math.abs(a(i).index('li[roadid="'+j+'"]')-c),a(i).attr("stageposition",h),a(i).find(".sortable-number").text(h),a(i).hasClass("ui-selected")&&(ha=h),N(parseInt(a(i).attr("stageid"),10),h,parseInt(a(i).attr("roadid"),10),e,f,g)}function m(a){var b=a.coordinate,c=e.proj.toLonLat(b,Fa.getView().getProjection()),d=e.coordinate.toStringHDMS(c),f='<a target="street" href="http://maps.google.com/?cbll='+c[1]+","+c[0]+'&cbp=12,20.09,,0,5&layer=c"><img src="pix/my_location.png" width="16" /></a>';Ba.innerHTML="<code>"+f+d+"</code>",Da.setPosition(b)}function n(a,b,c){var d=a.get("stageid"),e=a.get("roadid"),f=c.getFeatureById(d);f||(f=b.getFeatureById(d).clone(),f.setId(d),c.addFeature(f)),"empty"===f.get("idFeaturesPolygons")?(f.setProperties({idFeaturesPolygons:""+a.getId()}),A(d,e)):f.setProperties({idFeaturesPolygons:f.get("idFeaturesPolygons")+","+a.getId()}),f.getGeometry().appendPolygon(a.getGeometry())}function o(a,b,c,d){a.forEach(function(a){var f,g=a.get("stageid"),h=c.getFeatureById(g);h||(h=b.getFeatureById(g).clone(),h.setId(g),c.addFeature(h));var i=new e.geom.MultiPolygon([]);f=h.get("idFeaturesPolygons").split(",");for(var j=0,k=f.length;j<k;j++)i.appendPolygon(d.getSource().getFeatureById(f[j]).getGeometry().clone());h.setGeometry(i)})}function p(a,b,c,d){a.forEach(function(a){var f,g,h=a.get("stageid"),i=a.get("roadid"),j=c.getFeatureById(h);j||(j=b.getFeatureById(h).clone(),j.setId(h),c.addFeature(j));var k=new e.geom.MultiPolygon([]);f=j.get("idFeaturesPolygons").split(",");for(var l=0,m=f.length;l<m;l++)f[l]!=a.getId()?k.appendPolygon(d.getSource().getFeatureById(f[l]).getGeometry().clone()):g=l;j.setGeometry(k),k.getPolygons().length?(f.splice(g,1),j.setProperties({idFeaturesPolygons:f.join()})):(j.setProperties({idFeaturesPolygons:"empty"}),z(h,i))})}function q(a){var b=a.get("stageposition");return isNaN(b)||(xa.getText().setText(""+b),wa.getText().setText(""+b)),ra[a.getId()]?[xa]:[wa]}function r(b){var c=f.call([{methodname:"mod_treasurehunt_fetch_treasurehunt",args:{treasurehuntid:b}}]);c[0].done(function(b){if(a(".treasurehunt-editor-loader").hide(),b.status.code)d.alert("Error",b.status.msg,"Continue");else{var c,f,g=(b.treasurehunt.stages,new e.format.GeoJSON),h=b.treasurehunt.roads;Array.isArray(h)||(h=Object.values(h)),h.forEach(function(a){a.blocked=1==a.blocked,v(a.id,a.name,a.blocked),f=g.readFeatures(a.stages,{dataProjection:"EPSG:4326",featureProjection:W}),na.addFeatures(f),delete a.stages,c=new e.layer.Vector({source:new e.source.Vector({projection:W}),updateWhileAnimating:!0,style:q}),f.forEach(function(b){null===b.getGeometry()&&b.setGeometry(new e.geom.MultiPolygon([]));for(var d=b.getGeometry().getPolygons(),f="empty",g=b.get("stageposition"),h=b.get("name"),i=b.get("clue"),j=b.getId(),k=a.blocked,l=0;l<d.length;l++){var m=new e.Feature(b.getProperties());m.setProperties({stageid:j});var n=d[l];m.setGeometry(n),m.setId(sa),f=0===l?sa:f+","+sa,sa++,c.getSource().addFeature(m)}b.setProperties({idFeaturesPolygons:""+f}),u(j,a.id,g,h,i,k),0===d.length&&z(j)}),a.vector=c,Fa.addLayer(c),la.roads[a.id]=a}),y(),"undefined"!=typeof la.roads[i]?(ia=i,la.roads[ia].blocked?E():D(),L(ia,la.roads[ia].vector,Fa)):t(la.roads,Fa)}}).fail(function(b){a(".treasurehunt-editor-loader").hide(),console.log(b),d.exception(b)})}function s(a,b){a.forEach(function(a){b.getSource().removeFeature(a)}),a.clear()}function t(b,c){var d=0;for(var e in b)if(la.roads.hasOwnProperty(e)){d=1,ia=e,b[ia].blocked?E():D(),L(ia,b[ia].vector,c);break}0===d&&(E(),a("#addroad").addClass("highlightbutton"),a("#stagelistpanel").addClass("invisible"),c.updateSize())}function u(b,c,d,e,f,g){if(a('#stagelist li[stageid="'+b+'"]').length<1){var h=a('<li stageid="'+b+'" roadid="'+c+'" stageposition="'+d+'"/>').appendTo(a("#stagelist"));h.addClass("ui-corner-all").append("<div class='stagename'>"+e+"</div>").append("<div class='modifystage'><span class='ui-icon ui-icon-pencil'></span><span class='ui-icon ui-icon-info' data-id='#dialoginfo"+b+"'><div id='dialoginfo"+b+"' title='"+e+"'>"+f+"</div></span></div>"),g?h.addClass("blocked").prepend("<div class='nohandle validstage'><span class='ui-icon ui-icon-locked'></span><span class='sortable-number'>"+d+"</span></div>"):(h.prepend("<div class='handle validstage'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><span class='sortable-number'>"+d+"</span></div>"),h.children(".modifystage").prepend("<span class='ui-icon ui-icon-trash'></span>")),a("#dialoginfo"+b).dialog({maxHeight:500,autoOpen:!1})}else console.log("El li con "+b+" no ha podido crearse porque ya existia uno")}function v(b,c,d){if(a('#roadlist li[roadid="'+b+'"]').length<1){var e=a('<li roadid="'+b+'" blocked="'+d+'"/>').appendTo(a("#roadlist"));e.addClass("ui-corner-all").append("<div class='roadname'>"+c+"</div>").append("<div class='modifyroad'><span class='ui-icon ui-icon-trash'></span><span class='ui-icon ui-icon-pencil'></span></div>")}}function w(b){var c=a('#roadlist li[roadid="'+b+'"]');if(c.length>0){var d=a('#stagelist li[roadid="'+b+'"]');c.remove(),d.remove()}}function x(b,c,d,e){var f=a('#stagelist li[stageid="'+b+'"]');if(f.length>0){var g=f.attr("roadid"),h=f.index('li[roadid="'+g+'"]');f.remove();var i=a("#stagelist li[roadid='"+g+"']");K(i);for(var j=i.length,k=0;k<=h-1;k++)l(i,j,k,c,d,e)}}function y(){a("#stagelist li").sort(function(b,c){var d=parseInt(a(b).attr("stageposition")),e=parseInt(a(c).attr("stageposition"));return d<e?1:d>e?-1:0}).appendTo(a("#stagelist"))}function z(b,c){var d=a('#stagelist li[stageid="'+b+'"]');if(d.children(".handle,.nohandle").addClass("invalidstage").removeClass("validstage"),c){a("label[for='addradio']").addClass("highlightbutton");var e=a("#stagelist li[roadid='"+c+"']");e.length>=2&&a("#erremptystage").removeClass("invisible")}}function A(b,c){var d=a('#stagelist li[stageid="'+b+'"]');if(d.children(".handle, .nohandle").addClass("validstage").removeClass("invalidstage"),c){a("label[for='addradio']").removeClass("highlightbutton");var e=a("#stagelist li[roadid='"+c+"']");0===e.find(".invalidstage").length&&a("#erremptystage").addClass("invisible")}}function B(){a("#removefeature").button("option","disabled",!1)}function C(){a("#removefeature").button("option","disabled",!0)}function D(){a("#addstage").button("option","disabled",!1)}function E(){a("#addstage").button("option","disabled",!0)}function F(){a("#edition").find("input:radio");a("#edition").find("input:radio").prop("checked",!1).end().buttonset("refresh"),a("#edition").buttonset("disable"),Ha.setActive(!1),Ga.setActive(!1)}function G(){a("#edition").buttonset("enable")}function H(){a("#savestage").button("option","disabled",!1)}function I(){a("#savestage").button("option","disabled",!0)}function J(a,b,c){var d=700,e=a.getView();c?e.fit(c,{duration:d}):e.animate({zoom:19,center:b,duration:d})}function K(b){b.length>0?(a("#stagelistpanel").removeClass("invisible"),Fa.updateSize()):(a("#stagelistpanel").addClass("invisible"),Fa.updateSize()),b.length<2?(a("#addstage").addClass("highlightbutton"),a("#errvalidroad").removeClass("invisible"),a("#erremptystage").addClass("invisible")):b.find(".invalidstage").length>0?(a("#addstage").removeClass("highlightbutton"),a("#errvalidroad").addClass("invisible"),a("#erremptystage").removeClass("invisible")):(a("#addstage").removeClass("highlightbutton"),a("#errvalidroad").addClass("invisible"),a("#erremptystage").addClass("invisible"))}function L(b,c,d){a("#stagelist li").removeClass("ui-selected").hide();var f=a("#stagelist li[roadid='"+b+"']");f.show(),K(f),a("#roadlist li[roadid='"+b+"']").addClass("ui-selected"),d.getLayers().forEach(function(a){a instanceof e.layer.Vector&&a.setVisible(!1)}),c.setVisible(!0),c.getSource().getFeatures().length>0&&J(d,null,c.getSource().getExtent())}function M(a,b,c,d,e,f){b.getSource().clear(),d.clear(),ra={};var g=e.getFeatureById(c);if(!g&&(g=f.getFeatureById(c),!g))return void a.changed();if("empty"===g.get("idFeaturesPolygons"))return void a.changed();for(var h=g.get("idFeaturesPolygons").split(","),i=0,j=h.length;i<j;i++)b.getSource().addFeature(a.getSource().getFeatureById(h[i]).clone()),ra[h[i]]=!0;b.getSource().getFeatures().length&&J(Fa,null,b.getSource().getExtent())}function N(a,b,c,d,e,f){var g,h=d.getFeatureById(a);if(h||(h=e.getFeatureById(a).clone(),h.setId(a),d.addFeature(h)),h.setProperties({stageposition:b}),"empty"!==h.get("idFeaturesPolygons")){g=h.get("idFeaturesPolygons").split(",");for(var i=0,j=g.length;i<j;i++)f.getSource().getFeatureById(g[i]).setProperties({stageposition:b})}}function O(a,b){var c="editstage.php?cmid="+b+"&id="+a;window.location.href=c}function P(a,b){var c="editstage.php?cmid="+b+"&roadid="+a;window.location.href=c}function Q(a,b){var c="editroad.php?cmid="+b+"&id="+a;window.location.href=c}function R(a){var b="editroad.php?cmid="+a;window.location.href=b}function S(b,c,e,g,h){a(".treasurehunt-editor-loader").show();var i=f.call([{methodname:"mod_treasurehunt_delete_road",args:{roadid:b,treasurehuntid:g,lockid:h}}]);i[0].done(function(f){if(a(".treasurehunt-editor-loader").hide(),f.status.code)d.alert("Error",f.status.msg,"Continue");else{w(b),Fa.removeLayer(la.roads[b].vector),delete la.roads[b],t(la.roads,Fa),F();for(var g=e.getFeatures(),h=0;h<g.length;h++)if(b===g[h].get("roadid")){var i=c.getFeatureById(g[h].getId());i&&c.removeFeature(i),e.removeFeature(g[h])}}}).fail(function(b){a(".treasurehunt-editor-loader").hide(),console.log(b),d.exception(b)})}function T(b,c,e,g,h,i){a(".treasurehunt-editor-loader").show();var j=f.call([{methodname:"mod_treasurehunt_delete_stage",args:{stageid:b,treasurehuntid:h,lockid:i}}]);j[0].done(function(f){if(a(".treasurehunt-editor-loader").hide(),f.status.code)d.alert("Error",f.status.msg,"Continue");else{var h,i=!1,j=c.getFeatureById(b);if(x(b,c,e,g),j?("empty"!==j.get("idFeaturesPolygons")&&(i=j.get("idFeaturesPolygons").split(",")),c.removeFeature(j)):(j=e.getFeatureById(b),"empty"!==j.get("idFeaturesPolygons")&&(i=j.get("idFeaturesPolygons").split(",")),e.removeFeature(j)),i)for(var k=0,l=i.length;k<l;k++)h=g.getSource().getFeatureById(i[k]),g.getSource().removeFeature(h)}}).fail(function(b){a(".treasurehunt-editor-loader").hide(),console.log(b),d.exception(b)})}function U(b,c,g,h,i,j){a(".treasurehunt-editor-loader").show();var k,l=new e.format.GeoJSON,m=b.getFeatures(),n=[];m.forEach(function(a){k=a.clone(),k.unset("idFeaturesPolygons"),k.unset("name"),k.unset("clue"),k.unset("treasurehuntid"),k.setId(a.getId()),n.push(k)});var o=l.writeFeaturesObject(n,{dataProjection:"EPSG:4326",featureProjection:W}),p=f.call([{methodname:"mod_treasurehunt_update_stages",args:{stages:o,treasurehuntid:g,lockid:j}}]);p[0].done(function(e){if(a(".treasurehunt-editor-loader").hide(),e.status.code)d.alert("Error",e.status.msg,"Continue");else{var f;b.forEachFeature(function(a){f=c.getFeatureById(a.getId()),f.setProperties(a.getProperties()),f.setGeometry(a.getGeometry())}),b.clear(),I(),oa=!1,"function"==typeof h&&i instanceof Array&&h.apply(null,i)}}).fail(function(b){a(".treasurehunt-editor-loader").hide(),console.log(b),d.alert("Error",b.message,"Continue")})}function V(a){return a?"removeClass":"addClass"}var W="EPSG:3857",X=new e.proj.Projection(W),Y=null,Z=!0;if("undefined"!=typeof k&&null!=k){if(null!=k.custombackgroundurl){var $=e.proj.transformExtent(k.bbox,"EPSG:4326",W);if(!k.geographic){var _=($[2]-$[0],$[3]-$[1]),aa=($[2]+$[0])/2,ba=($[3]+$[1])/2,ca=Math.round(_/k.imgheight),da=Math.round(k.imgwidth*ca),ea=Math.round(k.imgheight*ca);$=[aa-da/2,ba-ea/2,aa+da/2,ba+ea/2]}Y=new e.layer.Image({title:k.layername,type:k.layertype,source:new e.source.ImageStatic({url:k.custombackgroundurl,imageExtent:$}),opacity:1})}else if(null!=k.wmsurl){var fa={source:new e.source.TileWMS({url:k.wmsurl,params:k.wmsparams}),type:k.layertype,title:k.layername};if(null!=k.bbox[0]&&null!=k.bbox[1]&&null!=k.bbox[2]&&null!=k.bbox[3]){var ga=e.proj.transformExtent(k.bbox,"EPSG:4326",W);fa.extent=ga}Y=new e.layer.Tile(fa)}Z=k.geographic}var ha,ia,ja,ka,la={roads:{}},ma=new e.source.Vector({projection:W}),na=new e.source.Vector({projection:W}),oa=!1,pa=!1,qa=!1,ra={},sa=1,ta=new e.layer.Vector({source:new e.source.Vector({projection:W})}),ua=g.createGeocoder("openstreetmap");a("#controlpanel").addClass("ui-widget-header ui-corner-all"),a('<span id="edition"/>').appendTo(a("#controlpanel")),a('<input type="radio" name="controlpanel" id="addradio" value="add">').appendTo(a("#edition")),a("<label>").attr("for","addradio").text(h.add).appendTo(a("#edition")),a('<input type="radio" name="controlpanel" id="modifyradio" value="modify">').appendTo(a("#edition")),a("<label>").attr("for","modifyradio").text(h.modify).appendTo(a("#edition")),a('<button id="savestage"/>').attr("disabled",!0).text(h.save).appendTo(a("#controlpanel")),a('<button id="removefeature"/>').attr("disabled",!0).text(h.remove).appendTo(a("#controlpanel")),Z&&(a('<div id="searchcontainer">').appendTo(a("#controlpanel")),a('<input type="search" placeholder="'+h.searchlocation+'" class="searchaddress"/>').appendTo(a("#searchcontainer")),a('<span class="ui-icon  ui-icon-search searchicon"></span>').prependTo(a("#searchcontainer")),a('<span class="ui-icon  ui-icon-closethick closeicon invisible"></span>').appendTo(a("#searchcontainer"))),a('<button id="addstage" />').text(h.stage).prependTo(a("#controlpanel")),a('<button id="addroad" />').text(h.road).prependTo(a("#controlpanel")),a("#addradio").button({text:!1,icons:{primary:"ui-icon-plusthick"}}),a("#modifyradio").button({text:!1,icons:{primary:"ui-icon-pencil"}}),a("#removefeature").button({text:!1,icons:{primary:"ui-icon-trash"}}),a("#savestage").button({text:!1,icons:{primary:"ui-icon-disk"}}),a("#addstage").button({icons:{primary:"ui-icon-circle-plus"}}),a("#addroad").button({icons:{primary:"ui-icon-circle-plus"}}),a("#edition").buttonset({disabled:!0}),a("#controlpanel").removeClass("invisible"),a('<ul id="stagelist"/>').prependTo(a("#stagelistpanel")),a("#stagelist").sortable({handle:".handle",tolerance:"pointer",zIndex:9999,opacity:.5,forcePlaceholderSize:!0,cursorAt:{top:-7},cursor:"n-resize",axis:"y",items:"li:not(:hidden , .blocked)",helper:"clone",start:function(b,c){var d=c.item.attr("roadid"),e=c.item.index('li[roadid="'+d+'"]'),f=a(this).data("ui-sortable").scrollParent,g=f[0].scrollHeight-f[0].clientHeight-c.helper.height();c.item.data("start_pos",e),a(this).data("maxScrollTop",g)},sort:function(b,c){var d=a(this).data("ui-sortable").scrollParent,e=a(this).data("maxScrollTop");d.scrollTop()>e&&d.scrollTop(e)},update:function(b,c){var d,e=c.item.data("start_pos"),f=c.item.attr("roadid"),g=c.item.index('li[roadid="'+f+'"]'),h=a(this).children('li[roadid="'+f+'"]'),i=a(h).length;if(e!==g){if(e<g)for(d=e;d<=g;d++)l(h,i,d,ma,na,la.roads[f].vector);else for(d=g;d<=e;d++)l(h,i,d,ma,na,la.roads[f].vector);H(),oa=!0}}}).disableSelection(),a('<ul id="roadlist"/>').appendTo(a("#roadlistpanel")),window.app={};var va=window.app;va.generateResizableControl=function(a){var b=a||{},c=document.createElement("button"),d=document.createElement("div");c.innerHTML="<>",c.id="egrip",d.className="ol-control ol-unselectable egrip-container",d.appendChild(c),e.control.Control.call(this,{element:d,target:b.target})},e.inherits(va.generateResizableControl,e.control.Control);var wa=new e.style.Style({fill:new e.style.Fill({color:"rgba(0, 0, 0, 0.1)"}),stroke:new e.style.Stroke({color:"#6C0492",width:2}),image:new e.style.Circle({radius:5,fill:new e.style.Fill({color:"#ffcc33"}),stroke:new e.style.Stroke({color:"#000000",width:2})}),text:new e.style.Text({textAlign:"center",scale:1.3,fill:new e.style.Fill({color:"#fff"}),stroke:new e.style.Stroke({color:"#6C0492",width:3.5})})}),xa=new e.style.Style({fill:new e.style.Fill({color:"rgba(0, 0, 0, 0.05)"}),stroke:new e.style.Stroke({color:"#FAC30B",width:2}),image:new e.style.Circle({radius:5,fill:new e.style.Fill({color:"#ffcc33"}),stroke:new e.style.Stroke({color:"#000000",width:2})}),text:new e.style.Text({textAlign:"center",scale:1.3,fill:new e.style.Fill({color:"#fff"}),stroke:new e.style.Stroke({color:"#ffcc33",width:3.5})}),zIndex:"Infinity"}),ya=new e.layer.Vector({source:new e.source.Vector({projection:"EPSG:3857"}),visible:!1}),za=new e.layer.Group({title:h.basemaps,layers:[new e.layer.Tile({title:h.aerialmap,type:"base",visible:!1,source:new e.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new e.layer.Tile({title:h.roadmap,type:"base",visible:!0,source:new e.source.OSM})]});null!=Y&&(k.onlybase&&za.getLayers().clear(),za.getLayers().push(Y));var Aa=document.getElementById("popup"),Ba=document.getElementById("popup-content"),Ca=document.getElementById("popup-closer"),Da=new e.Overlay({element:Aa,autoPan:!0,autoPanAnimation:{duration:250}});Ca.onclick=function(){return Da.setPosition(void 0),Ca.blur(),!1};var Ea=new e.control.LayerSwitcher,Fa=new e.Map({layers:[za,ya],overlays:[Da],projection:X,renderer:"canvas",target:"mapedit",view:new e.View({center:[0,0],zoom:2,minZoom:2}),controls:e.control.defaults().extend([Ea,new va.generateResizableControl({target:document.getElementById("stagelistpanel")})])});Fa.on("click",function(a){Ha.getActive()||Ga.getActive()||null!==k&&!k.geographic||m(a)}),Ea.showPanel(),a("#stagelistpanel").resizable({handles:{e:a("#egrip")},resize:function(a,b){b.size.height=b.originalSize.height},stop:function(a,b){Fa.updateSize()},cancel:""});var Ga={init:function(){this.select=new e.interaction.Select({filter:function(a){return!!ra[a.getId()]},style:function(a){var b=new e.style.Fill({color:"rgba(255,255,255,0.4)"}),c=new e.style.Stroke({color:"#3399CC",width:2}),d=[new e.style.Style({image:new e.style.Circle({fill:b,stroke:c,radius:5}),fill:b,stroke:c,text:new e.style.Text({text:""+a.get("stageposition"),textAlign:"center",scale:1.3,fill:new e.style.Fill({color:"#fff"}),stroke:new e.style.Stroke({color:"#3399CC",width:3.5})}),zIndex:"Infinity"})];return d}}),Fa.addInteraction(this.select),this.modify=new e.interaction.Modify({features:this.select.getFeatures(),style:new e.style.Style({image:new e.style.Circle({radius:5,fill:new e.style.Fill({color:"#3399CC"}),stroke:new e.style.Stroke({color:"#000000",width:2})})}),deleteCondition:function(a){return e.events.condition.shiftKeyOnly(a)&&e.events.condition.singleClick(a)}}),Fa.addInteraction(this.modify),this.setEvents()},setEvents:function(){ka=this.select.getFeatures(),this.select.on("change:active",function(){ka.clear(),C()}),this.select.on("select",function(){ka.getLength()>0?B():C()}),this.modify.on("modifyend",function(a){H(),o(a.features,na,ma,la.roads[ia].vector),oa=!0})},getActive:function(){return!(!this.select.getActive()||!this.modify.getActive())},setActive:function(a){this.select.setActive(a),this.modify.setActive(a)}};Ga.init();var Ha={init:function(){Fa.addInteraction(this.Polygon),this.Polygon.setActive(!1),this.setEvents()},Polygon:new e.interaction.Draw({source:ya.getSource(),type:"Polygon",style:new e.style.Style({fill:new e.style.Fill({color:"rgba(0, 0, 0, 0.05)"}),stroke:new e.style.Stroke({color:"#FAC30B",width:2}),image:new e.style.Circle({radius:5,fill:new e.style.Fill({color:"#ffcc33"}),stroke:new e.style.Stroke({color:"#000000",width:2})}),zIndex:"Infinity"})}),setEvents:function(){this.Polygon.on("drawend",function(a){qa=!1,pa?(ya.getSource().clear(),pa=!1):(a.feature.setProperties({roadid:ia,stageid:ja,stageposition:ha}),ra[sa]=!0,a.feature.setId(sa),sa++,la.roads[ia].vector.getSource().addFeature(a.feature),n(a.feature,na,ma),ya.getSource().clear(),H(),oa=!0)}),this.Polygon.on("drawstart",function(a){qa=!0})},getActive:function(){return this.Polygon.getActive()},setActive:function(a){a?this.Polygon.setActive(!0):this.Polygon.setActive(!1),Fa.getTargetElement().style.cursor=a?"none":""}};a(document).keyup(function(a){27===a.keyCode&&qa&&(pa=!0,Ha.Polygon.finishDrawing())}),Ha.init(),Ha.setActive(!1),Ga.setActive(!1),F();var Ia=new e.interaction.Snap({source:ya.getSource()});Fa.addInteraction(Ia),r(c),a(".searchaddress").autocomplete({minLength:4,source:function(a,b){var c=a.term;ua.geocode(c,function(a){if(!a[0])return void b();for(var c=[],d=0,e=a.length;d<e;d++){var f,g;f=a[d].getLatitude(),g=a[d].getLongitude();var h={value:a[d].totalName,latitude:f,longitude:g,boundingbox:a[d].boundingbox};c[d]=h}b(c)})},select:function(a,b){if(b.item.boundingbox){var c=[];c[0]=parseFloat(b.item.boundingbox[2]),c[1]=parseFloat(b.item.boundingbox[0]),c[2]=parseFloat(b.item.boundingbox[3]),c[3]=parseFloat(b.item.boundingbox[1]),c=e.proj.transformExtent(c,"EPSG:4326",W),J(Fa,null,c)}else{var d=e.proj.fromLonLat([b.item.longitude,b.item.latitude]);J(Fa,d)}},autoFocus:!0}).on("click",function(){a(this).autocomplete("search",a(this).value)}),a.ui.autocomplete.prototype._resizeMenu=function(){var a=this.menu.element;a.outerWidth(this.element.outerWidth())},a("#addstage").on("click",function(){oa?U(ma,na,c,P,[ia,b],j):P(ia,b)}),a("#addroad").on("click",function(){oa?U(ma,na,c,R,[b],j):R(b)}),a("#removefeature").on("click",function(){d.confirm(h.areyousure,h.removewarning,h.confirm,h.cancel,function(){p(ka,na,ma,la.roads[ia].vector),s(ka,la.roads[ia].vector),C(),H(),oa=!0})}),a("#savestage").on("click",function(){U(ma,na,c,null,null,j)}),a("#stagelist").on("click",".ui-icon-info, .ui-icon-alert",function(){var b=a(this).data("id");a(b).dialog("open"),a(".ui-dialog :button").blur()}),a("#stagelist").on("click",".ui-icon-trash",function(){var b=a(this).parents("li");d.confirm(h.areyousure,h.removewarning,h.confirm,h.cancel,function(){var a=parseInt(b.attr("stageid"));T(a,ma,na,la.roads[ia].vector,c,j)})}),a("#stagelist").on("click",".ui-icon-pencil",function(){var d=parseInt(a(this).parents("li").attr("stageid"));oa?U(ma,na,c,O,[d,b],j):O(d,b)});var Ja="off";a("input[name=controlpanel]:radio").on("click",function(){var b=Ja,c=a(this).prop("id");c==b&&(a("#edition").find("input:radio").buttonset().prop("checked",!1).end().buttonset("refresh"),c="off"),Ja=c,"addradio"===c?(Ha.setActive(!0),Ga.setActive(!1)):"modifyradio"===c?(Ha.setActive(!1),Ga.setActive(!0)):(Ha.setActive(!1),Ga.setActive(!1))}),a("#stagelist").on("click","li",function(b){return a(b.target).is(".handle ,.nohandle, .ui-icon , .sortable-number")?void b.preventDefault():(a(this).addClass("ui-selected").siblings().removeClass("ui-selected"),ha=parseInt(a(this).attr("stageposition")),ja=parseInt(a(this).attr("stageid")),M(la.roads[ia].vector,ta,ja,ka,ma,na),G(),a(this).find(".invalidstage").length>0?a("label[for='addradio']").addClass("highlightbutton"):a("label[for='addradio']").removeClass("highlightbutton"),void(qa&&(pa=!0,Ha.Polygon.finishDrawing())))}),a("#roadlist").on("click","li",function(b){if(a(b.target).is(".ui-icon"))return void b.preventDefault();a(this).addClass("ui-selected").siblings().removeClass("ui-selected"),ra={},qa&&(pa=!0,Ha.Polygon.finishDrawing()),ia=a(this).attr("roadid");var c=a(this).attr("blocked");parseInt(c)||"true"===c?E():D(),L(ia,la.roads[ia].vector,Fa),F();var d;d="fixed"===a("header[role=banner]").css("position")?parseInt(a(".treasurehunt-editor").offset().top)-parseInt(a("header[role=banner]").outerHeight(!0)):parseInt(a(".treasurehunt-editor").offset().top),a("html, body").animate({scrollTop:d},500)}),a("#roadlist").on("click",".ui-icon-pencil",function(){var d=parseInt(a(this).parents("li").attr("roadid"));oa?U(ma,na,c,Q,[d,b],j):Q(d,b)}),a("#roadlist").on("click",".ui-icon-trash",function(){var b=a(this).parents("li");d.confirm(h.areyousure,h.removeroadwarning,h.confirm,h.cancel,function(){var a=parseInt(b.attr("roadid"));S(a,ma,na,c,j)})}),Fa.on("pointermove",function(a){if(!a.dragging&&!Ha.getActive()&&Ga.getActive()){var b=Fa.getEventPixel(a.originalEvent),c=Fa.forEachFeatureAtPixel(b,function(a,b){if(ra[a.getId()]){var c=!1;return ka.forEach(function(b){a===b&&(c=!0)}),!c}return!1});Fa.getTargetElement().style.cursor=c?"pointer":""}}),a(document).on("touchend",".ui-dialog-titlebar-close",function(){a(this).parent().siblings(".ui-dialog-content").dialog("close")}),a(".searchaddress").on("input",function(){a(".closeicon")[V(this.value)]("invisible")}),a(".closeicon").on("touchstart click",function(b){b.preventDefault(),a(this).addClass("invisible"),a(".searchaddress").val("").change().autocomplete("close")}),window.onbeforeunload=function(a){var b=h.savewarning,a=a||window.event;if(oa)return a&&(a.returnValue=b),b}}var k={edittreasurehunt:function(a,b,c,d,e){var f=["stage","road","aerialmap","roadmap","basemaps","add","modify","save","remove","searchlocation","savewarning","removewarning","areyousure","removeroadwarning","confirm","cancel"],g=f.map(function(a){return{key:a,component:"treasurehunt"}});i.get_strings(g).done(function(g){for(var h=[],i=0;i<f.length;i++)h[f[i]]=g[i];if("undefined"!=typeof e&&null!==e&&null!==e.custombackgroundurl){var k=new Image;k.addEventListener("load",function(){e.imgwidth=this.naturalWidth,e.imgheight=this.naturalHeight,j(a,b,h,c,d,e)}),k.src=e.custombackgroundurl}else j(a,b,h,c,d,e)})}};return k});